<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>Case Game</title>
</head>
<body>

  <h1>Case Game</h1>
  <p id="balance">Загрузка...</p>
  <button id="spinBtn" onclick="spin()" disabled>
  Крутить дешёвый кейс
  </button>

  <script>
  const tg = window.Telegram.WebApp
  tg.expand()

  let currentUser = null

  async function auth() {
    const response = await fetch("/auth", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        initData: tg.initData
      })
    })

    const data = await response.json()

    if (data.error) {
      alert(data.error)
      return
    }

    currentUser = data

    document.getElementById("balance").innerText =
      "Баланс: " + data.balance

    // Разблокируем кнопку
    document.getElementById("spinBtn").disabled = false
  }

  async function spin() {
    if (!currentUser) {
      alert("Авторизация не завершена")
      return
    }

    const response = await fetch("/spin", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        telegram_id: currentUser.telegram_id,
        case_type: "cheap"
      })
    })

    const data = await response.json()

    if (data.error) {
      alert(data.error)
      return
    }

    alert("Выигрыш: " + data.win)

    document.getElementById("balance").innerText =
      "Баланс: " + data.new_balance

    currentUser.balance = data.new_balance
  }

  auth()
</script>

</body>
</html>